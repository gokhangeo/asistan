<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Yazışma Asistanı NextGen</title>
    
    <!-- PWA -->
    <meta name="theme-color" content="#4f46e5">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    
    <!-- Kütüphaneler -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src='https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js'></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <!-- Tailwind Config -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['"Outfit"', 'sans-serif'] },
                    colors: {
                        brand: { 50: '#eef2ff', 100: '#e0e7ff', 500: '#6366f1', 600: '#4f46e5', 700: '#4338ca', 900: '#312e81' }
                    },
                    animation: {
                        'blob': 'blob 7s infinite',
                        'fade-in-up': 'fadeInUp 0.5s ease-out forwards',
                        'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                    },
                    keyframes: {
                        blob: {
                            '0%': { transform: 'translate(0px, 0px) scale(1)' },
                            '33%': { transform: 'translate(30px, -50px) scale(1.1)' },
                            '66%': { transform: 'translate(-20px, 20px) scale(0.9)' },
                            '100%': { transform: 'translate(0px, 0px) scale(1)' },
                        },
                        fadeInUp: {
                            '0%': { opacity: '0', transform: 'translateY(20px)' },
                            '100%': { opacity: '1', transform: 'translateY(0)' },
                        }
                    }
                }
            }
        }
    </script>

    <style>
        body { background: #f0f4f8; overflow-x: hidden; }
        ::-webkit-scrollbar { width: 5px; height: 5px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        .glass-panel {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.5);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.07);
        }
        .blob-bg { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; z-index: -1; overflow: hidden; }
        .blob { position: absolute; border-radius: 50%; filter: blur(70px); opacity: 0.6; animation: blob 10s infinite alternate; }
        .cursor::after { content: '|'; animation: blink 1s step-start infinite; }
        @keyframes blink { 50% { opacity: 0; } }
        .btn-press:active { transform: scale(0.95); }
        .btn-hover:hover { transform: translateY(-2px); box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.1); }
        .group:hover .group-hover\:block { display: block; animation: fadeIn 0.2s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        .editor-height { min-height: 400px; }
    </style>
</head>
<body class="text-slate-800 min-h-screen flex flex-col antialiased selection:bg-brand-500 selection:text-white pb-10">
    
    <div class="blob-bg">
        <div class="blob bg-purple-300 w-96 h-96 top-0 -left-20 mix-blend-multiply filter blur-xl opacity-70 animate-blob"></div>
        <div class="blob bg-yellow-200 w-96 h-96 top-0 -right-20 mix-blend-multiply filter blur-xl opacity-70 animate-blob animation-delay-2000"></div>
        <div class="blob bg-pink-300 w-96 h-96 -bottom-32 left-20 mix-blend-multiply filter blur-xl opacity-70 animate-blob animation-delay-4000"></div>
    </div>

    <!-- Header -->
    <header class="w-full px-4 md:px-8 py-4 flex justify-between items-center glass-panel sticky top-0 z-50 transition-all duration-300 mb-6">
        <div class="flex items-center gap-3 group cursor-pointer">
            <div class="bg-gradient-to-tr from-brand-600 to-indigo-400 text-white p-2.5 rounded-2xl shadow-lg shadow-brand-500/40 group-hover:rotate-12 transition-transform duration-300">
                <i class="ph-bold ph-feather text-2xl"></i>
            </div>
            <div>
                <h1 class="text-xl font-bold tracking-tight text-slate-900 leading-none">Yazışma Asistanı <span class="text-brand-600">NextGen</span></h1>
                <p class="text-[10px] text-slate-500 font-semibold uppercase tracking-widest mt-0.5">Yapay Zeka Destekli</p>
            </div>
        </div>
        
        <div class="flex gap-2">
            <button onclick="toggleSettings()" class="btn-press btn-hover bg-white/80 backdrop-blur text-slate-600 px-3 py-2 rounded-xl border border-white shadow-sm flex items-center gap-2 text-sm font-medium hover:text-brand-600 transition-colors" title="API Ayarları">
                <i class="ph-bold ph-gear text-lg"></i>
            </button>
            <button onclick="toggleHistory()" class="btn-press btn-hover bg-white/80 backdrop-blur text-slate-600 px-4 py-2 rounded-xl border border-white shadow-sm flex items-center gap-2 text-sm font-medium hover:text-brand-600 transition-colors">
                <i class="ph-bold ph-clock-counter-clockwise text-lg"></i> <span class="hidden md:inline">Geçmiş</span>
            </button>
        </div>
    </header>

    <!-- Main Content -->
    <main class="flex-grow px-4 md:px-6 w-full max-w-[1600px] mx-auto">
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            
            <!-- LEFT COLUMN: Input & Tools -->
            <div class="flex flex-col gap-6 animate-fade-in-up" style="animation-delay: 0.1s;">
                
                <!-- Tools Area -->
                <div class="glass-panel rounded-2xl p-4 z-40 relative">
                    <div class="flex flex-wrap gap-3 items-center">
                        
                        <!-- Şablonlar -->
                        <div class="relative group">
                            <button class="btn-press bg-white hover:bg-slate-50 text-slate-700 px-4 py-3 rounded-xl border border-slate-100 shadow-sm flex items-center gap-2 text-sm font-bold transition-all w-full sm:w-auto justify-center">
                                <i class="ph-duotone ph-file-text text-xl text-brand-500"></i> Şablonlar
                            </button>
                            <div class="absolute top-full left-0 mt-2 w-64 bg-white/95 backdrop-blur-xl rounded-2xl shadow-2xl border border-white/50 hidden group-hover:block p-2 z-50 transform origin-top-left transition-all duration-200">
                                <div class="text-[10px] uppercase font-bold text-slate-400 px-3 py-2">Hızlı Başlangıç</div>
                                <button onclick="loadTemplate('izin')" class="w-full text-left px-3 py-3 rounded-xl hover:bg-brand-50 text-sm text-slate-700 transition-colors flex items-center gap-3"><div class="bg-blue-100 text-blue-600 p-1.5 rounded-lg"><i class="ph-bold ph-calendar-check"></i></div> Yıllık İzin</button>
                                <button onclick="loadTemplate('tutanak')" class="w-full text-left px-3 py-3 rounded-xl hover:bg-brand-50 text-sm text-slate-700 transition-colors flex items-center gap-3"><div class="bg-orange-100 text-orange-600 p-1.5 rounded-lg"><i class="ph-bold ph-scroll"></i></div> Tutanak</button>
                                <button onclick="loadTemplate('gorev')" class="w-full text-left px-3 py-3 rounded-xl hover:bg-brand-50 text-sm text-slate-700 transition-colors flex items-center gap-3"><div class="bg-emerald-100 text-emerald-600 p-1.5 rounded-lg"><i class="ph-bold ph-briefcase"></i></div> Görevlendirme</button>
                            </div>
                        </div>

                        <!-- Sihirli Araçlar -->
                        <div class="relative group">
                            <button class="btn-press bg-gradient-to-r from-violet-500 to-fuchsia-500 text-white px-4 py-3 rounded-xl shadow-lg shadow-violet-500/20 flex items-center gap-2 text-sm font-bold transition-all hover:brightness-110 w-full sm:w-auto justify-center">
                                <i class="ph-fill ph-sparkle"></i> Sihirli Araçlar
                            </button>
                            <div class="absolute top-full left-0 mt-2 w-72 bg-white/95 backdrop-blur-xl rounded-2xl shadow-2xl border border-white/50 hidden group-hover:block p-2 z-50 transform origin-top-left transition-all duration-200">
                                <div class="px-3 py-2 text-[10px] uppercase font-bold text-slate-400">Yapay Zeka İşlemleri</div>
                                <button onclick="runMagicTool('summarize')" class="w-full text-left px-3 py-3 rounded-xl hover:bg-violet-50 text-sm text-slate-700 transition-colors flex items-center gap-3 group/item">
                                    <div class="bg-violet-100 text-violet-600 p-2 rounded-lg group-hover/item:bg-violet-600 group-hover/item:text-white transition-all"><i class="ph-bold ph-list-bullets"></i></div><div><div class="font-bold text-slate-800">Özet Çıkar</div><div class="text-[10px] text-slate-500">Kısalt ve maddeler</div></div>
                                </button>
                                <button onclick="runMagicTool('email')" class="w-full text-left px-3 py-3 rounded-xl hover:bg-violet-50 text-sm text-slate-700 transition-colors flex items-center gap-3 group/item">
                                    <div class="bg-violet-100 text-violet-600 p-2 rounded-lg group-hover/item:bg-violet-600 group-hover/item:text-white transition-all"><i class="ph-bold ph-envelope-simple"></i></div><div><div class="font-bold text-slate-800">E-postaya Çevir</div><div class="text-[10px] text-slate-500">Resmi dilden maile</div></div>
                                </button>
                                <button onclick="runMagicTool('reply')" class="w-full text-left px-3 py-3 rounded-xl hover:bg-violet-50 text-sm text-slate-700 transition-colors flex items-center gap-3 group/item">
                                    <div class="bg-violet-100 text-violet-600 p-2 rounded-lg group-hover/item:bg-violet-600 group-hover/item:text-white transition-all"><i class="ph-bold ph-arrow-u-up-left"></i></div><div><div class="font-bold text-slate-800">Cevap Taslağı</div><div class="text-[10px] text-slate-500">Gelen evraka yanıt</div></div>
                                </button>
                                <button onclick="runMagicTool('translate')" class="w-full text-left px-3 py-3 rounded-xl hover:bg-violet-50 text-sm text-slate-700 transition-colors flex items-center gap-3 group/item">
                                    <div class="bg-violet-100 text-violet-600 p-2 rounded-lg group-hover/item:bg-violet-600 group-hover/item:text-white transition-all"><i class="ph-bold ph-translate"></i></div><div><div class="font-bold text-slate-800">İngilizce Çeviri</div><div class="text-[10px] text-slate-500">Diplomatik dil</div></div>
                                </button>
                            </div>
                        </div>
                        
                        <div class="h-8 w-px bg-slate-300 mx-2 hidden sm:block"></div>

                        <!-- Actions -->
                        <div class="flex gap-2 w-full sm:w-auto justify-center sm:justify-start">
                            <button id="micButton" class="btn-press w-12 h-12 rounded-xl bg-white border border-slate-100 text-slate-500 hover:text-red-500 hover:bg-red-50 shadow-sm flex items-center justify-center transition-colors" title="Sesle Yaz"><i class="ph-bold ph-microphone text-xl"></i></button>
                            <button id="scanButton" class="btn-press w-12 h-12 rounded-xl bg-white border border-slate-100 text-slate-500 hover:text-brand-600 hover:bg-brand-50 shadow-sm flex items-center justify-center transition-colors" title="Kamera"><i class="ph-bold ph-camera text-xl"></i></button>
                            <button id="pdfButton" class="btn-press w-12 h-12 rounded-xl bg-white border border-slate-100 text-slate-500 hover:text-rose-600 hover:bg-rose-50 shadow-sm flex items-center justify-center transition-colors" title="PDF Yükle"><i class="ph-bold ph-file-pdf text-xl"></i></button>
                            <button onclick="clearInput()" class="btn-press w-12 h-12 rounded-xl bg-white border border-slate-100 text-slate-400 hover:text-red-500 hover:bg-red-50 shadow-sm flex items-center justify-center transition-colors ml-auto sm:ml-0"><i class="ph-bold ph-trash text-xl"></i></button>
                        </div>

                        <input type="file" id="imageInput" accept="image/*" class="hidden">
                        <input type="file" id="pdfInput" accept="application/pdf" class="hidden">
                    </div>
                </div>

                <!-- Editor Area -->
                <div class="relative glass-panel rounded-3xl group focus-within:ring-4 ring-brand-500/10 transition-all duration-300 flex-grow editor-height">
                    <textarea id="inputText" class="w-full h-full p-6 bg-transparent resize-none focus:outline-none text-slate-700 text-lg leading-relaxed font-normal placeholder:text-slate-400 min-h-[400px]" placeholder="Bir şeyler yazın, konuşun veya evrak yükleyin..."></textarea>
                    
                    <div class="absolute bottom-0 inset-x-0 bg-white/50 backdrop-blur-md border-t border-white/50 px-5 py-3 rounded-b-3xl flex justify-between text-xs font-semibold text-slate-500 tracking-wide z-10">
                        <span id="wordCount">0 Kelime</span>
                        <span id="charCount">0 Karakter</span>
                    </div>
                    
                    <!-- Loading Overlay -->
                    <div id="processStatus" class="absolute inset-0 bg-slate-900/40 backdrop-blur-md rounded-3xl flex flex-col items-center justify-center text-white z-20 opacity-0 pointer-events-none transition-opacity duration-300">
                        <div class="relative">
                            <div class="w-16 h-16 border-4 border-white/30 border-t-white rounded-full animate-spin"></div>
                            <div class="absolute inset-0 flex items-center justify-center"><i class="ph-fill ph-cpu text-2xl animate-pulse"></i></div>
                        </div>
                        <p id="processText" class="mt-4 font-semibold tracking-wide">İşleniyor...</p>
                    </div>
                </div>

                <!-- Action Bar -->
                <div class="glass-panel rounded-2xl p-4 flex flex-col sm:flex-row gap-4">
                    <div class="flex-grow relative">
                        <select id="toneSelect" class="w-full h-14 appearance-none bg-white/50 border border-white/50 text-slate-700 pl-4 pr-10 rounded-xl focus:outline-none focus:ring-2 focus:ring-brand-500/20 font-medium cursor-pointer hover:bg-white transition-colors text-base">
                            <option value="standard">Resmi (Standart)</option>
                            <option value="petition">Dilekçe Formatı</option>
                            <option value="polite">Nazik / Rica Üslubu</option>
                            <option value="executive">Yönetici Özeti (Kısa)</option>
                            <option value="academic">Akademik / Teknik</option>
                            <option value="fix_only">Sadece İmla Düzelt</option>
                        </select>
                        <i class="ph-bold ph-caret-down absolute right-4 top-1/2 -translate-y-1/2 text-slate-400 pointer-events-none text-xl"></i>
                    </div>
                    
                    <button id="correctButton" class="btn-press btn-hover bg-gradient-to-r from-brand-600 to-indigo-600 hover:from-brand-500 hover:to-indigo-500 text-white h-14 px-8 rounded-xl font-bold shadow-lg shadow-brand-500/30 flex items-center justify-center gap-2 whitespace-nowrap tracking-wide text-lg">
                        <i class="ph-fill ph-magic-wand text-2xl"></i>
                        Yapay Zeka ile Düzenle
                    </button>
                </div>
            </div>

            <!-- RIGHT COLUMN -->
            <div class="flex flex-col gap-6 animate-fade-in-up" style="animation-delay: 0.2s;">
                <div class="glass-panel rounded-2xl p-3 flex justify-between items-center">
                    <span class="font-bold text-emerald-700 bg-emerald-50 px-4 py-2 rounded-lg flex items-center gap-2 text-sm shadow-sm border border-emerald-100">
                        <i class="ph-fill ph-check-circle text-xl"></i> Sonuç
                    </span>
                    <div class="flex gap-2">
                        <button onclick="exportWord()" id="wordBtn" class="btn-press w-10 h-10 rounded-lg bg-white border border-slate-100 text-blue-600 hover:bg-blue-50 flex items-center justify-center transition-colors disabled:opacity-50" disabled title="Word"><i class="ph-bold ph-file-doc text-xl"></i></button>
                        <button id="printBtn" class="btn-press w-10 h-10 rounded-lg bg-white border border-slate-100 text-slate-600 hover:bg-slate-50 flex items-center justify-center transition-colors disabled:opacity-50" disabled title="Yazdır"><i class="ph-bold ph-printer text-xl"></i></button>
                        <button id="copyBtn" class="btn-press w-10 h-10 rounded-lg bg-white border border-slate-100 text-emerald-600 hover:bg-emerald-50 flex items-center justify-center transition-colors disabled:opacity-50" disabled title="Kopyala"><i class="ph-bold ph-copy text-xl"></i></button>
                        <button id="shareBtn" class="btn-press w-10 h-10 rounded-lg bg-white border border-slate-100 text-purple-600 hover:bg-purple-50 flex items-center justify-center transition-colors disabled:opacity-50" disabled title="Paylaş"><i class="ph-bold ph-share-network text-xl"></i></button>
                    </div>
                </div>

                <div class="relative glass-panel rounded-3xl overflow-hidden shadow-sm flex-grow editor-height">
                    <div id="outputTextContainer" class="h-full overflow-y-auto p-6 md:p-8 min-h-[400px]">
                        <div id="printArea" class="hidden"></div>
                        <div id="outputText" class="prose prose-slate prose-lg max-w-none text-slate-800 whitespace-pre-wrap leading-relaxed empty:hidden font-medium">
                            <div class="flex flex-col items-center justify-center h-full min-h-[300px] text-slate-400 select-none opacity-60">
                                <div class="w-24 h-24 bg-white rounded-full flex items-center justify-center mb-4 shadow-inner border border-slate-100"><i class="ph-duotone ph-sparkle text-5xl text-brand-300 animate-pulse-slow"></i></div>
                                <p class="text-sm font-semibold tracking-wide">Sonuç burada yazılacak...</p>
                            </div>
                        </div>
                    </div>
                    <div id="loadingSpinner" class="absolute inset-0 bg-white/60 backdrop-blur-md flex flex-col items-center justify-center z-20 hidden">
                        <div class="flex items-center gap-1.5 mb-6">
                            <span class="w-4 h-4 bg-brand-500 rounded-full animate-bounce" style="animation-delay: 0s"></span>
                            <span class="w-4 h-4 bg-brand-500 rounded-full animate-bounce" style="animation-delay: 0.1s"></span>
                            <span class="w-4 h-4 bg-brand-500 rounded-full animate-bounce" style="animation-delay: 0.2s"></span>
                        </div>
                        <p id="loadingText" class="text-brand-700 font-bold text-sm tracking-widest uppercase animate-pulse">Yapay Zeka Düşünüyor...</p>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- History Modal -->
    <div id="historyModal" class="fixed inset-0 z-[60] hidden bg-slate-900/20 backdrop-blur-sm transition-opacity duration-300">
        <div class="absolute inset-y-0 right-0 w-full max-w-md bg-white/90 backdrop-blur-xl shadow-2xl transform transition-transform duration-300 translate-x-full flex flex-col" id="historyPanel">
            <div class="p-5 border-b border-slate-100 flex justify-between items-center bg-white/50">
                <h2 class="text-lg font-bold text-slate-800 flex items-center gap-2"><i class="ph-duotone ph-clock-counter-clockwise text-brand-600 text-2xl"></i> İşlem Geçmişi</h2>
                <button onclick="toggleHistory()" class="p-2 hover:bg-slate-100 rounded-full transition-colors"><i class="ph-bold ph-x text-xl"></i></button>
            </div>
            <div id="historyList" class="flex-1 overflow-y-auto p-4 space-y-3"></div>
            <div class="p-4 border-t border-slate-100 bg-white/50">
                <button onclick="clearHistory()" class="w-full py-3 text-red-600 hover:bg-red-50 rounded-xl text-sm font-bold transition-colors flex items-center justify-center gap-2 border border-transparent hover:border-red-100"><i class="ph-bold ph-trash"></i> Tüm Geçmişi Temizle</button>
            </div>
        </div>
    </div>

    <!-- Settings Modal (New) -->
    <div id="settingsModal" class="fixed inset-0 z-[70] hidden bg-slate-900/30 backdrop-blur-md flex items-center justify-center p-4 transition-opacity duration-300">
        <div class="bg-white rounded-3xl shadow-2xl max-w-md w-full p-6 animate-blob">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold text-slate-800 flex items-center gap-2"><i class="ph-fill ph-gear text-brand-600"></i> Ayarlar</h2>
                <button onclick="toggleSettings()" class="text-slate-400 hover:text-slate-600"><i class="ph-bold ph-x text-xl"></i></button>
            </div>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-1">Google Gemini API Anahtarı</label>
                    <input type="password" id="apiKeyInput" class="w-full p-3 rounded-xl border border-slate-200 focus:ring-2 focus:ring-brand-500 focus:border-brand-500 outline-none transition-all" placeholder="AI Studio'dan alınan anahtarı buraya yapıştırın...">
                    <p class="text-xs text-slate-500 mt-2">
                        Anahtarınız sadece tarayıcınızda (Local Storage) saklanır. Ücretsiz anahtar almak için <a href="https://aistudio.google.com/app/apikey" target="_blank" class="text-brand-600 hover:underline">Google AI Studio</a>'yu ziyaret edin.
                    </p>
                </div>
                <div class="bg-blue-50 p-3 rounded-lg flex gap-3 text-sm text-blue-700 border border-blue-100">
                    <i class="ph-fill ph-info text-xl shrink-0"></i>
                    <p>Kendi anahtarınızı girerseniz sistem daha hızlı ve stabil çalışır (Limitlere takılmazsınız).</p>
                </div>
                <button onclick="saveSettings()" class="w-full bg-brand-600 hover:bg-brand-700 text-white font-bold py-3 rounded-xl transition-all shadow-lg shadow-brand-500/30">Kaydet</button>
            </div>
        </div>
    </div>

    <script>
        // --- CONSTANTS ---
        const CANVAS_KEY = ""; // Canvas environment handles this automatically if empty
        let userApiKey = localStorage.getItem('gemini_user_api_key') || "";
        let historyData = JSON.parse(localStorage.getItem('yazismaHistoryElite')) || [];
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

        // --- DOM ---
        const els = {
            input: document.getElementById('inputText'),
            output: document.getElementById('outputText'),
            outputContainer: document.getElementById('outputTextContainer'),
            wordCount: document.getElementById('wordCount'),
            charCount: document.getElementById('charCount'),
            toneSelect: document.getElementById('toneSelect'),
            loading: document.getElementById('loadingSpinner'),
            loadingText: document.getElementById('loadingText'),
            processStatus: document.getElementById('processStatus'),
            processText: document.getElementById('processText'),
            apiKeyInput: document.getElementById('apiKeyInput'),
            btns: {
                correct: document.getElementById('correctButton'),
                copy: document.getElementById('copyBtn'),
                word: document.getElementById('wordBtn'),
                print: document.getElementById('printBtn'),
                share: document.getElementById('shareBtn'),
                mic: document.getElementById('micButton'),
                scan: document.getElementById('scanButton'),
                pdf: document.getElementById('pdfButton')
            },
            history: {
                modal: document.getElementById('historyModal'),
                panel: document.getElementById('historyPanel'),
                list: document.getElementById('historyList')
            },
            settings: {
                modal: document.getElementById('settingsModal')
            }
        };

        // --- Settings Logic ---
        function toggleSettings() {
            els.settings.modal.classList.toggle('hidden');
            if(!els.settings.modal.classList.contains('hidden')) {
                els.apiKeyInput.value = userApiKey;
            }
        }

        function saveSettings() {
            const key = els.apiKeyInput.value.trim();
            if(key) {
                localStorage.setItem('gemini_user_api_key', key);
                userApiKey = key;
                alert("Anahtar kaydedildi! Artık kendi API anahtarınızla çalışıyorsunuz.");
            } else {
                localStorage.removeItem('gemini_user_api_key');
                userApiKey = "";
                alert("Anahtar silindi. Varsayılan sistem kullanılacak.");
            }
            toggleSettings();
        }

        // --- Live Stats ---
        els.input.addEventListener('input', () => {
            const text = els.input.value;
            els.charCount.textContent = `${text.length} Karakter`;
            els.wordCount.textContent = `${text.trim() === '' ? 0 : text.trim().split(/\s+/).length} Kelime`;
        });

        // --- Typewriter Effect ---
        function typeWriterEffect(text, element) {
            element.innerHTML = '';
            element.classList.add('cursor');
            let i = 0;
            const speed = 10;
            function type() {
                if (i < text.length) {
                    if(text.charAt(i) === '\n') { element.innerHTML += '<br>'; } 
                    else { element.textContent += text.charAt(i); element.innerHTML = element.innerHTML.replace(/\n/g, '<br>'); }
                    i++;
                    if(i % 10 === 0) els.outputContainer.scrollTo({ top: els.outputContainer.scrollHeight, behavior: 'smooth' });
                    setTimeout(type, speed);
                } else {
                    element.classList.remove('cursor');
                    element.innerHTML = text.replace(/\n/g, '<br>'); 
                    try { confetti({ particleCount: 120, spread: 80, origin: { y: 0.6 }, colors: ['#4f46e5', '#8b5cf6', '#ec4899'] }); } catch(e){}
                }
            }
            type();
        }

        // --- Templates & Clear ---
        function loadTemplate(key) {
            const templates = {
                izin: "....... MÜDÜRLÜĞÜNE\n\nKurumunuzda ....... sicil numarası ile ....... olarak görev yapmaktayım. .../.../202.. tarihinden itibaren ... gün süreyle yıllık iznimi kullanmak istiyorum.\n\nGereğini bilgilerinize arz ederim.",
                tutanak: "TUTANAK\n\nKONU: .......\n\n.../.../202.. tarihinde saat ...:... sularında ....... yerinde meydana gelen olayda; ........................................................................... tespit edilmiştir.",
                gorev: "....... MAKAMINA\n\nİlgi: .../.../202.. tarihli ve ....... sayılı yazı.\n\n....... tarihinde düzenlenecek olan ....... toplantısına katılmak üzere görevlendirilmesi hususunu arz ederim.",
                istifa: "....... YÖNETİM KURULU BAŞKANLIĞI'NA\n\n.../.../202.. tarihinden beri çalıştığım ....... görevimden istifa ediyorum."
            };
            els.input.value = templates[key];
            els.input.dispatchEvent(new Event('input'));
            els.input.focus();
        }

        function clearInput() {
            if(confirm("Taslak silinsin mi?")) {
                els.input.value = '';
                els.input.dispatchEvent(new Event('input'));
                els.output.innerHTML = `<div class="flex flex-col items-center justify-center h-full min-h-[300px] text-slate-400 select-none opacity-60"><div class="w-24 h-24 bg-white rounded-full flex items-center justify-center mb-4 shadow-inner border border-slate-100"><i class="ph-duotone ph-sparkle text-5xl text-brand-300 animate-pulse-slow"></i></div><p class="text-sm font-semibold tracking-wide">Sonuç burada yazılacak...</p></div>`;
                setActionsEnabled(false);
            }
        }

        function showProcessStatus(show, text = "İşleniyor...") {
            els.processText.innerText = text;
            els.processStatus.style.opacity = show ? '1' : '0';
            els.processStatus.style.pointerEvents = show ? 'auto' : 'none';
        }

        // --- PDF Logic (Robust Sorting & Cleaning) ---
        const pdfInput = document.getElementById('pdfInput');
        els.btns.pdf.onclick = () => pdfInput.click();
        pdfInput.onchange = async (e) => {
            const file = e.target.files[0];
            if (!file) return;
            showProcessStatus(true, "PDF Taranıyor...");
            
            try {
                const arrayBuffer = await file.arrayBuffer();
                const pdf = await pdfjsLib.getDocument(arrayBuffer).promise;
                let fullText = "";
                let originalText = "";

                for (let i = 1; i <= pdf.numPages; i++) {
                    showProcessStatus(true, `PDF... Sayfa ${i}/${pdf.numPages}`);
                    const page = await pdf.getPage(i);
                    const textContent = await page.getTextContent();
                    
                    // Sorting by Y (top to bottom), then X (left to right)
                    const items = textContent.items;
                    items.sort((a, b) => {
                        const yDiff = b.transform[5] - a.transform[5];
                        if (Math.abs(yDiff) > 10) return yDiff; 
                        return a.transform[4] - b.transform[4]; 
                    });

                    let lastY = -1;
                    let pageStr = "";
                    items.forEach(item => {
                        const currentY = item.transform[5];
                        if (lastY !== -1 && Math.abs(currentY - lastY) > 10) pageStr += "\n";
                        else if (lastY !== -1) pageStr += " ";
                        pageStr += item.str;
                        lastY = currentY;
                    });
                    
                    originalText += pageStr + "\n\n";
                }
                
                // Cleaning Header Logic
                const lines = originalText.split('\n');
                let cleanedLines = [];
                let headerPassed = false;
                let lineCount = 0;

                for(let line of lines) {
                    lineCount++;
                    const l = line.trim().toLowerCase();
                    // Detect common header parts in first 20 lines
                    if (!headerPassed && lineCount < 20 && (
                        l.includes('t.c.') || l.includes('t.c ') || 
                        l.startsWith('sayı:') || l.startsWith('konu:') || 
                        l.startsWith('tarih:') || l.includes('müdürlüğü') || l.includes('başkanlığı')
                    )) {
                        continue; 
                    }
                    headerPassed = true;
                    cleanedLines.push(line);
                }
                
                fullText = cleanedLines.join('\n').trim();
                if(fullText.length < 10) fullText = originalText; // Fallback

                els.input.value = fullText;
                els.input.dispatchEvent(new Event('input'));

            } catch (error) {
                console.error(error);
                alert("PDF okunamadı. Lütfen 'Kamera' butonunu deneyin.");
            } finally {
                showProcessStatus(false);
                pdfInput.value = '';
            }
        };

        // --- Core AI ---
        async function callGeminiAPI(prompt, successMessage = "İşlem Tamamlandı") {
            els.loading.classList.remove('hidden');
            els.btns.correct.disabled = true;
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 45000);
            
            const finalPrompt = prompt + "\n\nÖNEMLİ: Cevapta 'T.C.', 'Sayı', 'Konu', 'Tarih' gibi resmi evrak başlıklarını KESİNLİKLE kullanma. Sadece metnin GÖVDE (içerik) kısmını yaz.";

            // Determine API Key and Model
            const apiKeyToUse = userApiKey || CANVAS_KEY;
            // Use 1.5 Flash if user provides key (stable/free), otherwise use Preview model for Canvas
            const modelToUse = userApiKey ? 'gemini-1.5-flash' : 'gemini-2.5-flash-preview-09-2025';

            try {
                const resp = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${modelToUse}:generateContent?key=${apiKeyToUse}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ role: "user", parts: [{ text: finalPrompt }] }] }),
                    signal: controller.signal
                });
                clearTimeout(timeoutId);
                const data = await resp.json();
                
                if (!resp.ok) {
                    const msg = data.error?.message || "Servis Hatası";
                    if(msg.includes('API key')) throw new Error("API Anahtarı geçersiz. Lütfen ayarlardan kontrol edin.");
                    throw new Error(msg);
                }
                
                const corrected = data.candidates?.[0]?.content?.parts?.[0]?.text?.trim();
                if (corrected) {
                    typeWriterEffect(corrected, els.output);
                    setActionsEnabled(true);
                    if(window.innerWidth < 1024) els.outputContainer.scrollIntoView({behavior: 'smooth'});
                    try { saveToHistory(els.input.value.substring(0,100), corrected, successMessage); } catch(e){}
                } else { throw new Error('Yanıt alınamadı.'); }
            } catch (err) {
                els.output.innerHTML = `<div class="bg-red-50 text-red-600 p-6 rounded-2xl text-center border border-red-200"><i class="ph-bold ph-warning-circle text-4xl mb-3"></i><br><strong>Hata:</strong> ${err.message}</div>`;
            } finally {
                els.loading.classList.add('hidden');
                els.btns.correct.disabled = false;
            }
        }

        // --- Handlers ---
        els.btns.correct.addEventListener('click', () => {
            const text = els.input.value.trim();
            if (!text) return alert("Metin giriniz.");
            const tone = els.toneSelect.value;
            let prompt = "Sen uzman bir resmi yazışma asistanısın. ";
            if (tone === 'standard') prompt += "Metni standart resmi kurallara göre düzenle.";
            else if (tone === 'petition') prompt += "Metni dilekçe formatına çevir.";
            else if (tone === 'polite') prompt += "Metni daha nazik bir dille yaz.";
            else if (tone === 'executive') prompt += "Metni yönetici özeti olarak kısalt.";
            else if (tone === 'academic') prompt += "Metni akademik dille yaz.";
            else if (tone === 'fix_only') prompt += "Sadece imla hatalarını düzelt.";
            prompt += `\n\nMetin:\n${text}\n\nSadece sonucu ver.`;
            els.loadingText.textContent = "YAZI DÜZENLENİYOR...";
            callGeminiAPI(prompt, "Düzenleme");
        });

        function runMagicTool(toolType) {
            const text = els.input.value.trim();
            if (!text) return alert("Metin giriniz.");
            let prompt = "", actionName = "";
            if (toolType === 'summarize') { actionName = "Özet"; els.loadingText.textContent = "ÖZETLENİYOR..."; prompt = `Metni maddeler halinde özetle:\n${text}`; } 
            else if (toolType === 'email') { actionName = "E-posta"; els.loadingText.textContent = "DÖNÜŞTÜRÜLÜYOR..."; prompt = `Metni profesyonel e-postaya çevir:\n${text}`; } 
            else if (toolType === 'reply') { actionName = "Cevap"; els.loadingText.textContent = "CEVAP YAZILIYOR..."; prompt = `Gelen evraka uygun cevap yaz:\n${text}`; } 
            else if (toolType === 'translate') { actionName = "Çeviri"; els.loadingText.textContent = "ÇEVRİLİYOR..."; prompt = `Resmi İngilizceye çevir:\n${text}`; }
            if(prompt) callGeminiAPI(prompt, actionName);
        }

        // Helpers
        function setActionsEnabled(enabled) {
            [els.btns.copy, els.btns.print, els.btns.share, els.btns.word].forEach(btn => {
                btn.disabled = !enabled;
                enabled ? btn.classList.remove('opacity-50') : btn.classList.add('opacity-50');
            });
            if(enabled) document.getElementById('printArea').innerHTML = els.output.innerText.replace(/\n/g, '<br>');
        }
        els.btns.copy.onclick = () => { navigator.clipboard.writeText(els.output.innerText); els.btns.copy.innerHTML = '<i class="ph-bold ph-check text-lg text-emerald-600"></i>'; setTimeout(() => els.btns.copy.innerHTML = '<i class="ph-bold ph-copy text-xl"></i>', 2000); };
        els.btns.print.onclick = () => window.print();
        function exportWord() { /* ... */ }
        function toggleHistory() { els.history.modal.classList.toggle('hidden'); if(!els.history.modal.classList.contains('hidden')) renderHistory(); }
        function saveToHistory(o, c, t) { historyData.unshift({id:Date.now(), date:new Date().toLocaleString('tr-TR'), original:o, corrected:c, tone:t}); if(historyData.length>20) historyData.pop(); localStorage.setItem('yazismaHistoryElite', JSON.stringify(historyData)); }
        function renderHistory() { els.history.list.innerHTML = historyData.map(i => `<div onclick="els.output.innerText=\`${i.corrected}\`;setActionsEnabled(true);toggleHistory()" class="bg-white/60 p-3 rounded-xl border border-slate-100 shadow-sm cursor-pointer mb-2"><div class="flex justify-between text-[10px] text-slate-400 mb-1"><span>${i.tone}</span><span>${i.date}</span></div><p class="text-xs line-clamp-2">${i.original}</p></div>`).join('') || '<div class="text-center text-slate-400 py-5">Geçmiş boş.</div>'; }
        function clearHistory() { if(confirm('Silinsin mi?')) { historyData=[]; localStorage.removeItem('yazismaHistoryElite'); renderHistory(); } }
        
        // OCR Handler
        els.btns.scan.onclick = () => document.getElementById('imageInput').click();
        document.getElementById('imageInput').onchange = (e) => {
            if(!e.target.files[0]) return;
            showProcessStatus(true, "OCR Okunuyor...");
            Tesseract.recognize(e.target.files[0], 'tur').then(({data:{text}}) => { els.input.value=text; els.input.dispatchEvent(new Event('input')); }).finally(()=>showProcessStatus(false));
        };
        // Mic Handler
        if('webkitSpeechRecognition' in window) {
            const r = new webkitSpeechRecognition(); r.lang='tr-TR';
            els.btns.mic.onclick = () => { els.btns.mic.classList.contains('bg-red-500') ? r.stop() : r.start(); };
            r.onstart = () => els.btns.mic.classList.add('bg-red-500', 'text-white', 'animate-pulse');
            r.onend = () => els.btns.mic.classList.remove('bg-red-500', 'text-white', 'animate-pulse');
            r.onresult = e => { els.input.value += (els.input.value ? ' ' : '') + e.results[0][0].transcript; els.input.dispatchEvent(new Event('input')); };
        } else els.btns.mic.style.display='none';
    </script>
</body>
</html>
