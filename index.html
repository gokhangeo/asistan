<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Yazışma Asistanı Elite</title>
    
    <!-- PWA -->
    <meta name="theme-color" content="#4f46e5">
    <meta name="apple-mobile-web-app-capable" content="yes">
    
    <!-- Kütüphaneler -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src='https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js'></script>
    <!-- PDF.js Kütüphanesi -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <!-- Tailwind Config -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['"Plus Jakarta Sans"', 'sans-serif'] },
                    colors: {
                        brand: { 50: '#eef2ff', 100: '#e0e7ff', 500: '#6366f1', 600: '#4f46e5', 700: '#4338ca', 900: '#312e81' }
                    },
                    animation: {
                        'float': 'float 6s ease-in-out infinite',
                        'slide-up': 'slideUp 0.5s ease-out'
                    },
                    keyframes: {
                        float: { '0%, 100%': { transform: 'translateY(0)' }, '50%': { transform: 'translateY(-10px)' } },
                        slideUp: { '0%': { transform: 'translateY(20px)', opacity: '0' }, '100%': { transform: 'translateY(0)', opacity: '1' } }
                    }
                }
            }
        }
    </script>

    <style>
        body { background: #f8fafc; overflow-x: hidden; }
        /* Modern Scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        
        /* Glass Effect */
        .glass {
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.5);
        }
        
        .gradient-bg {
            background: radial-gradient(circle at 0% 0%, #4f46e5 0%, transparent 50%), 
                        radial-gradient(circle at 100% 100%, #0ea5e9 0%, transparent 50%);
            opacity: 0.05;
            position: fixed; inset: 0; z-index: -1;
        }

        /* Print Styles */
        @media print {
            body * { visibility: hidden; }
            #printArea, #printArea * { visibility: visible; }
            #printArea { position: absolute; left: 0; top: 0; width: 100%; padding: 2cm; font-family: 'Times New Roman', serif; font-size: 12pt; color: black; line-height: 1.5; }
        }

        .tool-btn { @apply p-2 rounded-lg transition-all duration-200 flex items-center gap-2 text-sm font-medium; }
        .tool-btn:hover { @apply bg-brand-50 text-brand-700 transform -translate-y-0.5; }
    </style>
</head>
<body class="text-slate-800 h-screen flex flex-col">
    
    <div class="gradient-bg"></div>

    <!-- Header -->
    <header class="w-full px-6 py-4 flex justify-between items-center glass sticky top-0 z-30 shadow-sm">
        <div class="flex items-center gap-3">
            <div class="bg-gradient-to-br from-brand-500 to-sky-500 text-white p-2.5 rounded-xl shadow-lg shadow-brand-500/30">
                <i class="ph-bold ph-feather text-2xl"></i>
            </div>
            <div>
                <h1 class="text-xl font-bold tracking-tight text-slate-900">Yazışma Asistanı <span class="text-brand-600">Elite</span></h1>
                <p class="text-xs text-slate-500 font-medium">Yapay Zeka Destekli Editör</p>
            </div>
        </div>
        
        <div class="flex gap-2">
            <button onclick="toggleHistory()" class="tool-btn text-slate-600 bg-white border border-slate-200 hover:border-brand-200 shadow-sm">
                <i class="ph ph-clock-counter-clockwise text-lg"></i> <span class="hidden md:inline">Geçmiş</span>
            </button>
        </div>
    </header>

    <!-- Main Content -->
    <main class="flex-grow p-4 md:p-6 overflow-hidden">
        <div class="max-w-8xl mx-auto h-full grid grid-cols-1 lg:grid-cols-2 gap-6">
            
            <!-- LEFT COLUMN: Input & Tools -->
            <div class="flex flex-col h-full gap-4 animate-slide-up">
                <!-- Toolbar -->
                <div class="bg-white rounded-2xl p-3 shadow-sm border border-slate-200 flex flex-wrap gap-2 items-center justify-between">
                    <div class="flex gap-2 overflow-x-auto pb-1 md:pb-0 hide-scrollbar items-center">
                        <!-- Template Dropdown -->
                        <div class="relative group">
                            <button class="tool-btn bg-slate-50 text-slate-700 border border-slate-200">
                                <i class="ph ph-file-text"></i> Şablonlar
                            </button>
                            <div class="absolute top-full left-0 mt-1 w-48 bg-white rounded-xl shadow-xl border border-slate-100 hidden group-hover:block z-50 p-1">
                                <button onclick="loadTemplate('izin')" class="w-full text-left px-3 py-2 rounded-lg hover:bg-slate-50 text-sm text-slate-600 transition-colors">Yıllık İzin Formu</button>
                                <button onclick="loadTemplate('tutanak')" class="w-full text-left px-3 py-2 rounded-lg hover:bg-slate-50 text-sm text-slate-600 transition-colors">Toplantı Tutanağı</button>
                                <button onclick="loadTemplate('gorev')" class="w-full text-left px-3 py-2 rounded-lg hover:bg-slate-50 text-sm text-slate-600 transition-colors">Görevlendirme Yazısı</button>
                                <button onclick="loadTemplate('istifa')" class="w-full text-left px-3 py-2 rounded-lg hover:bg-slate-50 text-sm text-slate-600 transition-colors">İstifa Dilekçesi</button>
                            </div>
                        </div>
                        
                        <button id="micButton" class="tool-btn bg-slate-50 text-slate-700 hover:text-red-600 hover:bg-red-50 border border-transparent">
                            <i class="ph ph-microphone text-lg"></i> <span class="hidden sm:inline">Dikte</span>
                        </button>
                        <button id="scanButton" class="tool-btn bg-slate-50 text-slate-700 hover:text-brand-600 border border-transparent">
                            <i class="ph ph-camera text-lg"></i> <span class="hidden sm:inline">Tara</span>
                        </button>
                        
                        <!-- PDF Butonu -->
                        <button id="pdfButton" class="tool-btn bg-slate-50 text-slate-700 hover:text-rose-600 border border-transparent">
                            <i class="ph ph-file-pdf text-lg"></i> <span class="hidden sm:inline">PDF Yükle</span>
                        </button>

                        <input type="file" id="imageInput" accept="image/*" class="hidden">
                        <input type="file" id="pdfInput" accept="application/pdf" class="hidden">
                    </div>

                    <div class="flex items-center gap-2">
                        <button onclick="clearInput()" class="p-2 text-slate-400 hover:text-red-500 transition-colors" title="Temizle">
                            <i class="ph ph-trash text-lg"></i>
                        </button>
                    </div>
                </div>

                <!-- Editor Area -->
                <div class="flex-grow relative bg-white rounded-3xl shadow-lg border border-slate-200 group focus-within:ring-2 ring-brand-100 transition-all duration-300">
                    <textarea id="inputText" class="w-full h-full p-6 bg-transparent resize-none focus:outline-none text-slate-700 text-lg leading-relaxed font-normal placeholder:text-slate-300" placeholder="Metninizi buraya yazın, PDF yükleyin veya bir şablon seçin..."></textarea>
                    
                    <!-- Stats Bar -->
                    <div class="absolute bottom-0 inset-x-0 bg-slate-50/80 backdrop-blur border-t border-slate-100 px-4 py-2 rounded-b-3xl flex justify-between text-xs font-medium text-slate-500">
                        <span id="wordCount">0 Kelime</span>
                        <span id="charCount">0 Karakter</span>
                    </div>
                    
                    <!-- OCR & PDF Processing Overlay -->
                    <div id="processStatus" class="absolute inset-0 bg-slate-900/80 backdrop-blur-sm rounded-3xl flex flex-col items-center justify-center text-white z-20 opacity-0 pointer-events-none transition-opacity duration-300">
                        <div class="w-12 h-12 border-4 border-white/20 border-t-white rounded-full animate-spin mb-3"></div>
                        <p id="processText">İşleniyor...</p>
                    </div>
                </div>

                <!-- Action Bar -->
                <div class="bg-white rounded-2xl p-3 shadow-sm border border-slate-200 flex flex-col sm:flex-row gap-3">
                    <div class="flex-grow relative">
                        <select id="toneSelect" class="w-full appearance-none bg-slate-50 border border-slate-200 text-slate-700 py-3 px-4 pr-8 rounded-xl focus:outline-none focus:ring-2 focus:ring-brand-500/20 font-medium cursor-pointer">
                            <option value="standard">Resmi (Standart)</option>
                            <option value="petition">Dilekçe Formatı</option>
                            <option value="polite">Nazik / Rica Üslubu</option>
                            <option value="executive">Yönetici Özeti (Kısa)</option>
                            <option value="academic">Akademik / Teknik</option>
                            <option value="fix_only">Sadece İmla Düzelt</option>
                        </select>
                        <i class="ph-bold ph-caret-down absolute right-4 top-1/2 -translate-y-1/2 text-slate-400 pointer-events-none"></i>
                    </div>
                    
                    <button id="correctButton" class="bg-gradient-to-r from-brand-600 to-brand-500 hover:from-brand-700 hover:to-brand-600 text-white py-3 px-8 rounded-xl font-bold shadow-lg shadow-brand-500/30 transform active:scale-95 transition-all flex items-center justify-center gap-2 whitespace-nowrap">
                        <i class="ph-fill ph-magic-wand"></i>
                        Yapay Zeka ile Düzenle
                    </button>
                </div>
            </div>

            <!-- RIGHT COLUMN: Output -->
            <div class="flex flex-col h-full gap-4 animate-slide-up" style="animation-delay: 0.1s;">
                <!-- Output Toolbar -->
                <div class="bg-white rounded-2xl p-3 shadow-sm border border-slate-200 flex justify-between items-center">
                    <span class="font-semibold text-emerald-600 flex items-center gap-2 px-2">
                        <i class="ph-fill ph-check-circle text-xl"></i> Hazır Metin
                    </span>
                    <div class="flex gap-1">
                        <button onclick="exportWord()" id="wordBtn" class="tool-btn hover:bg-blue-50 hover:text-blue-600 opacity-50 cursor-not-allowed" disabled title="Word İndir">
                            <i class="ph ph-file-doc text-lg"></i> <span class="hidden lg:inline">Word</span>
                        </button>
                        <button id="printBtn" class="tool-btn hover:bg-slate-100 opacity-50 cursor-not-allowed" disabled title="PDF/Yazdır">
                            <i class="ph ph-printer text-lg"></i>
                        </button>
                        <button id="copyBtn" class="tool-btn hover:bg-emerald-50 hover:text-emerald-600 opacity-50 cursor-not-allowed" disabled title="Kopyala">
                            <i class="ph ph-copy text-lg"></i>
                        </button>
                        <button id="shareBtn" class="tool-btn hover:bg-purple-50 hover:text-purple-600 opacity-50 cursor-not-allowed" disabled title="Paylaş">
                            <i class="ph ph-share-network text-lg"></i>
                        </button>
                    </div>
                </div>

                <!-- Output Editor -->
                <div class="flex-grow relative bg-white rounded-3xl shadow-lg border border-slate-200 overflow-hidden">
                    <div id="outputTextContainer" class="h-full overflow-y-auto p-6 md:p-8 bg-white">
                        <div id="printArea" class="hidden"></div> <!-- Hidden Print Area -->
                        
                        <div id="outputText" class="prose prose-slate prose-lg max-w-none text-slate-800 whitespace-pre-wrap leading-relaxed empty:hidden">
                            <!-- Empty State -->
                            <div class="flex flex-col items-center justify-center h-full min-h-[300px] text-slate-300 select-none">
                                <div class="w-20 h-20 bg-slate-50 rounded-full flex items-center justify-center mb-4">
                                    <i class="ph ph-sparkle text-4xl text-slate-200"></i>
                                </div>
                                <p class="text-sm font-medium">Sonuç burada görüntülenecek</p>
                            </div>
                        </div>
                    </div>

                    <!-- Loading Overlay -->
                    <div id="loadingSpinner" class="absolute inset-0 bg-white/90 backdrop-blur-sm flex flex-col items-center justify-center z-20 hidden">
                        <div class="flex items-center gap-1 mb-4">
                            <span class="w-3 h-3 bg-brand-500 rounded-full animate-bounce" style="animation-delay: 0s"></span>
                            <span class="w-3 h-3 bg-brand-500 rounded-full animate-bounce" style="animation-delay: 0.1s"></span>
                            <span class="w-3 h-3 bg-brand-500 rounded-full animate-bounce" style="animation-delay: 0.2s"></span>
                        </div>
                        <p id="loadingText" class="text-brand-600 font-medium text-sm animate-pulse">Yapay zeka en uygun kelimeleri seçiyor...</p>
                    </div>
                </div>
            </div>

        </div>
    </main>

    <!-- History Slide-Over -->
    <div id="historyModal" class="fixed inset-0 z-50 hidden bg-slate-900/20 backdrop-blur-sm transition-opacity">
        <div class="absolute inset-y-0 right-0 w-full max-w-md bg-white shadow-2xl transform transition-transform duration-300 translate-x-full flex flex-col" id="historyPanel">
            <div class="p-5 border-b border-slate-100 flex justify-between items-center bg-slate-50/50">
                <h2 class="text-lg font-bold text-slate-800 flex items-center gap-2">
                    <i class="ph-fill ph-clock-counter-clockwise text-brand-600"></i> İşlem Geçmişi
                </h2>
                <button onclick="toggleHistory()" class="p-2 hover:bg-slate-100 rounded-full transition-colors">
                    <i class="ph ph-x text-lg"></i>
                </button>
            </div>
            <div id="historyList" class="flex-1 overflow-y-auto p-4 space-y-3 bg-slate-50/30">
                <!-- Items will be injected here -->
            </div>
            <div class="p-4 border-t border-slate-100 bg-white">
                <button onclick="clearHistory()" class="w-full py-3 text-red-600 hover:bg-red-50 rounded-xl text-sm font-semibold transition-colors flex items-center justify-center gap-2">
                    <i class="ph ph-trash"></i> Tüm Geçmişi Temizle
                </button>
            </div>
        </div>
    </div>

    <footer class="text-center py-3 text-slate-400 text-[10px] font-medium tracking-wide uppercase">
        Designed for Excellence by Gökhan Elgül
    </footer>

    <script>
        // --- Config & Globals ---
        const apiKey = "AIzaSyCxG-n6HpUKNB1_OWlurIxApRhRfgFMHfc";
        let historyData = JSON.parse(localStorage.getItem('yazismaHistoryElite')) || [];
        
        // PDF.js Worker Ayarı
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

        // --- DOM Elements ---
        const els = {
            input: document.getElementById('inputText'),
            output: document.getElementById('outputText'),
            outputContainer: document.getElementById('outputTextContainer'),
            wordCount: document.getElementById('wordCount'),
            charCount: document.getElementById('charCount'),
            toneSelect: document.getElementById('toneSelect'),
            loading: document.getElementById('loadingSpinner'),
            loadingText: document.getElementById('loadingText'),
            processStatus: document.getElementById('processStatus'),
            processText: document.getElementById('processText'),
            btns: {
                correct: document.getElementById('correctButton'),
                copy: document.getElementById('copyBtn'),
                word: document.getElementById('wordBtn'),
                print: document.getElementById('printBtn'),
                share: document.getElementById('shareBtn'),
                mic: document.getElementById('micButton'),
                scan: document.getElementById('scanButton'),
                pdf: document.getElementById('pdfButton')
            },
            history: {
                modal: document.getElementById('historyModal'),
                panel: document.getElementById('historyPanel'),
                list: document.getElementById('historyList')
            }
        };

        // --- Live Stats ---
        els.input.addEventListener('input', () => {
            const text = els.input.value;
            els.charCount.textContent = `${text.length} Karakter`;
            els.wordCount.textContent = `${text.trim() === '' ? 0 : text.trim().split(/\s+/).length} Kelime`;
        });

        // --- Templates ---
        const templates = {
            izin: "....... MÜDÜRLÜĞÜNE\n\nKurumunuzda ....... sicil numarası ile ....... olarak görev yapmaktayım. .../.../202.. tarihinden itibaren ... gün süreyle yıllık iznimi kullanmak istiyorum. İznimi ....... adresinde geçireceğim.\n\nGereğini bilgilerinize arz ederim.\n\nAdres:\nTel:",
            tutanak: "TUTANAK\n\nKONU: .......\n\n.../.../202.. tarihinde saat ...:... sularında ....... yerinde meydana gelen olayda; ......................................................................................................................................................................... tespit edilmiştir.\n\nİşbu tutanak tarafımızca imza altına alınmıştır.",
            gorev: "....... MAKAMINA\n\nİlgi: .../.../202.. tarihli ve ....... sayılı yazı.\n\n....... tarihinde ....... ilinde düzenlenecek olan ....... toplantısına/eğitimine katılmak üzere, ....... personelinin görevlendirilmesi hususunu;\n\nOlurlarınıza arz ederim.",
            istifa: "....... YÖNETİM KURULU BAŞKANLIĞI'NA\n\n.../.../202.. tarihinden beri şirketinizde ....... pozisyonunda çalışmaktayım. Özel sebeplerden dolayı .../.../202.. tarihi itibarıyla görevimden istifa ediyorum.\n\nGerekli işlemlerin yapılmasını saygılarımla arz ederim."
        };

        function loadTemplate(key) {
            els.input.value = templates[key];
            els.input.dispatchEvent(new Event('input'));
            els.input.focus();
        }

        function clearInput() {
            if(confirm("Taslak silinsin mi?")) {
                els.input.value = '';
                els.input.dispatchEvent(new Event('input'));
                els.output.innerHTML = `<div class="flex flex-col items-center justify-center h-full min-h-[300px] text-slate-300 select-none"><div class="w-20 h-20 bg-slate-50 rounded-full flex items-center justify-center mb-4"><i class="ph ph-sparkle text-4xl text-slate-200"></i></div><p class="text-sm font-medium">Sonuç burada görüntülenecek</p></div>`;
                setActionsEnabled(false);
            }
        }

        function showProcessStatus(show, text = "İşleniyor...") {
            els.processText.innerText = text;
            els.processStatus.style.opacity = show ? '1' : '0';
            els.processStatus.style.pointerEvents = show ? 'auto' : 'none';
        }

        // --- Speech Recognition ---
        if ('webkitSpeechRecognition' in window) {
            const recognition = new webkitSpeechRecognition();
            recognition.lang = 'tr-TR';
            recognition.continuous = false;
            
            els.btns.mic.onclick = () => {
                if (els.btns.mic.classList.contains('bg-red-500')) recognition.stop();
                else recognition.start();
            };

            recognition.onstart = () => {
                els.btns.mic.classList.remove('bg-slate-50', 'text-slate-700');
                els.btns.mic.classList.add('bg-red-500', 'text-white', 'animate-pulse');
            };

            recognition.onend = () => {
                els.btns.mic.classList.add('bg-slate-50', 'text-slate-700');
                els.btns.mic.classList.remove('bg-red-500', 'text-white', 'animate-pulse');
            };

            recognition.onresult = (e) => {
                const t = e.results[0][0].transcript;
                els.input.value = els.input.value ? els.input.value + " " + t : t;
                els.input.dispatchEvent(new Event('input'));
            };
        } else {
            els.btns.mic.style.display = 'none';
        }

        // --- OCR (Image) ---
        const imgInput = document.getElementById('imageInput');
        els.btns.scan.onclick = () => imgInput.click();
        imgInput.onchange = (e) => {
            const file = e.target.files[0];
            if(!file) return;
            
            showProcessStatus(true, "Görsel Okunuyor...");
            
            Tesseract.recognize(file, 'tur').then(({ data: { text } }) => {
                els.input.value = text;
                els.input.dispatchEvent(new Event('input'));
            }).finally(() => {
                showProcessStatus(false);
                imgInput.value = '';
            });
        };

        // --- PDF UPLOAD & PARSE LOGIC ---
        const pdfInput = document.getElementById('pdfInput');
        els.btns.pdf.onclick = () => pdfInput.click();

        pdfInput.onchange = async (e) => {
            const file = e.target.files[0];
            if (!file) return;
            if (file.type !== 'application/pdf') {
                alert('Lütfen geçerli bir PDF dosyası seçin.');
                return;
            }

            showProcessStatus(true, "PDF Ayrıştırılıyor...");

            try {
                const arrayBuffer = await file.arrayBuffer();
                const pdf = await pdfjsLib.getDocument(arrayBuffer).promise;
                let fullText = '';

                for (let i = 1; i <= pdf.numPages; i++) {
                    showProcessStatus(true, `PDF Okunuyor... Sayfa ${i}/${pdf.numPages}`);
                    const page = await pdf.getPage(i);
                    const textContent = await page.getTextContent();
                    const pageText = textContent.items.map(item => item.str).join(' ');
                    fullText += pageText + "\n\n";
                }

                els.input.value = fullText.trim();
                els.input.dispatchEvent(new Event('input'));

            } catch (error) {
                console.error('PDF Hatası:', error);
                alert('PDF okunurken bir hata oluştu. Dosya şifreli veya bozuk olabilir.');
            } finally {
                showProcessStatus(false);
                pdfInput.value = '';
            }
        };

        // --- AI Processing (GÜNCELLENMİŞ - ZAMAN AŞIMI KORUMALI) ---
        els.btns.correct.addEventListener('click', async () => {
            const text = els.input.value.trim();
            if (!text) return alert("Lütfen metin girin.");

            // UI Hazırlığı
            els.loading.classList.remove('hidden');
            els.btns.correct.disabled = true;
            
            const tone = els.toneSelect.value;
            let prompt = "Sen uzman bir resmi yazışma asistanısın. ";
            
            if (tone === 'standard') prompt += "Metni standart resmi yazışma kurallarına ve TDK'ya göre düzenle.";
            else if (tone === 'petition') prompt += "Metni resmi bir dilekçe formatına dönüştür (Giriş, gelişme, Arz ederim vb.).";
            else if (tone === 'polite') prompt += "Metni daha nazik, yapıcı ve işbirlikçi bir dille (rica ederek) yeniden yaz.";
            else if (tone === 'executive') prompt += "Metni yöneticiler için kısa, öz ve net maddeler halinde özetle.";
            else if (tone === 'academic') prompt += "Metni akademik ve teknik bir dille, edilgen çatı kullanarak yeniden yaz.";
            else if (tone === 'fix_only') prompt += "Metnin içeriğini ve üslubunu değiştirmeden sadece imla ve gramer hatalarını düzelt.";

            prompt += `\n\nMetin:\n${text}\n\nSadece sonucu ver.`;

            // Zaman Aşımı Denetleyicisi (30 Saniye)
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 30000);

            try {
                const resp = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ role: "user", parts: [{ text: prompt }] }] }),
                    signal: controller.signal // Sinyali bağladık
                });

                clearTimeout(timeoutId); // İşlem başarılı, zaman aşımını iptal et

                if (!resp.ok) {
                    throw new Error(`Sunucu Hatası (${resp.status})`);
                }

                const result = await resp.json();
                const corrected = result.candidates?.[0]?.content?.parts?.[0]?.text?.trim();

                if (corrected) {
                    els.output.innerText = corrected;
                    
                    // Kutlama efekti (Hata verirse akışı bozmasın diye try-catch içinde)
                    try {
                        confetti({ particleCount: 100, spread: 70, origin: { y: 0.6 }, colors: ['#4f46e5', '#0ea5e9'] });
                    } catch(e) { console.log("Efekt hatası", e); }
                    
                    setActionsEnabled(true);
                    
                    // Geçmişe kaydetme (Hata verirse akışı bozmasın)
                    try {
                        saveToHistory(text, corrected, tone);
                    } catch(e) { console.error("Geçmiş kayıt hatası:", e); }
                    
                    if(window.innerWidth < 1024) els.outputContainer.scrollIntoView({behavior: 'smooth'});
                } else {
                    throw new Error('Yapay zeka boş bir yanıt döndürdü.');
                }
            } catch (err) {
                // Hata mesajını göster
                let msg = err.message;
                if (err.name === 'AbortError') {
                    msg = "İşlem zaman aşımına uğradı (30sn). Lütfen internet bağlantınızı kontrol edip tekrar deneyin.";
                }
                els.output.innerHTML = `<span class="text-red-500 font-bold">Hata: ${msg}</span>`;
            } finally {
                // Her durumda yükleniyor ekranını kaldır ve butonu aktif et
                els.loading.classList.add('hidden');
                els.btns.correct.disabled = false;
            }
        });

        // --- Output Actions ---
        function setActionsEnabled(enabled) {
            const btns = [els.btns.copy, els.btns.print, els.btns.share, els.btns.word];
            btns.forEach(btn => {
                btn.disabled = !enabled;
                btn.classList.toggle('opacity-50', !enabled);
                btn.classList.toggle('cursor-not-allowed', !enabled);
            });
            if(enabled) {
                document.getElementById('printArea').innerHTML = els.output.innerText.replace(/\n/g, '<br>');
            }
        }

        els.btns.copy.onclick = () => {
            navigator.clipboard.writeText(els.output.innerText);
            const i = els.btns.copy.querySelector('i');
            const originalClass = i.className;
            i.className = "ph-bold ph-check text-emerald-600";
            setTimeout(() => i.className = originalClass, 2000);
        };

        els.btns.print.onclick = () => window.print();

        // Word Export Logic
        function exportWord() {
            const text = els.output.innerText;
            const content = `
                <html xmlns:o='urn:schemas-microsoft-com:office:office' xmlns:w='urn:schemas-microsoft-com:office:word' xmlns='http://www.w3.org/TR/REC-html40'>
                <head><meta charset='utf-8'><title>Belge</title></head>
                <body>
                    <p style="font-family: 'Times New Roman', serif; font-size: 12pt;">
                        ${text.replace(/\n/g, '<br>')}
                    </p>
                </body>
                </html>`;
            
            const blob = new Blob(['\ufeff', content], { type: 'application/msword' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `Resmi_Yazi_${new Date().toISOString().slice(0,10)}.doc`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // --- History ---
        function toggleHistory() {
            els.history.modal.classList.toggle('hidden');
            const panel = els.history.panel;
            if (els.history.modal.classList.contains('hidden')) {
                panel.classList.remove('translate-x-0');
                panel.classList.add('translate-x-full');
            } else {
                panel.classList.remove('translate-x-full');
                panel.classList.add('translate-x-0');
                renderHistory();
            }
        }

        function saveToHistory(orig, corr, tone) {
            historyData.unshift({ id: Date.now(), date: new Date().toLocaleString('tr-TR'), original: orig, corrected: corr, tone: tone });
            if(historyData.length > 20) historyData.pop();
            localStorage.setItem('yazismaHistoryElite', JSON.stringify(historyData));
        }

        function renderHistory() {
            const list = els.history.list;
            list.innerHTML = '';
            if (!historyData.length) return list.innerHTML = '<div class="text-center text-slate-400 py-10">Geçmiş boş.</div>';
            
            historyData.forEach(item => {
                const div = document.createElement('div');
                div.className = 'bg-white p-4 rounded-xl border border-slate-100 shadow-sm hover:shadow-md transition-shadow cursor-pointer';
                div.onclick = () => { els.output.innerText = item.corrected; setActionsEnabled(true); toggleHistory(); };
                div.innerHTML = `
                    <div class="flex justify-between mb-2">
                        <span class="text-[10px] font-bold uppercase bg-brand-50 text-brand-600 px-2 py-0.5 rounded">${item.tone}</span>
                        <span class="text-[10px] text-slate-400">${item.date}</span>
                    </div>
                    <p class="text-xs text-slate-600 line-clamp-2 font-medium">${item.original}</p>
                `;
                list.appendChild(div);
            });
        }
        
        function clearHistory() {
            if(confirm("Tüm geçmiş silinecek?")) {
                historyData = [];
                localStorage.removeItem('yazismaHistoryElite');
                renderHistory();
            }
        }
    </script>
</body>
</html>
